# 架構書 1208 (Comprehensive Edition)

**專案名稱：** 旅遊筆記本 (Travel Notebook)
**版本：** 1208 (Pre-Alpha / Dev)
**目標：** 提供一個高顏值、手機優先的 React PWA，解決團體旅遊中的「資訊分散」、「行程變動」與「分帳困難」三大痛點。

---

## 1. 技術架構 (Technology Stack)

本專案採用現代化 React 生態系，強調開發者體驗 (DX) 與使用者體驗 (UX)。

| 類別 | 選型 | 詳細說明 |
| :--- | :--- | :--- |
| **Runtime** | **Vite** | 極速開發體驗，秒級 HMR。 |
| **Framework** | **React 18** | 使用 Functional Components 與 Hooks。 |
| **Language** | **TypeScript** | 強型別，確保資料結構 (如 `Expense`, `FlightSegment`) 的一致性。 |
| **Styling** | **Tailwind CSS** | Utility-first CSS。專案定義了 `macaron` (馬卡龍) 色票系統。 |
| **Backend** | **Supabase** | Backend-as-a-Service。提供 PostgreSQL 資料庫與 API。 |
| **Data Fetching** | **TanStack Query (v5)** | `useQuery` / `useMutation` 管理 Server State，具備自動快取與重新驗證功能。 |
| **Date Library** | **date-fns** | 輕量級日期處理 (Formatting, Grouping)。 |
| **Icons** | **Lucide React** | 統一風格的 SVG 圖標庫。 |
| **UI Components** | **Sonner** | 漂亮的 Toast 通知元件。 |

---

## 2. 資料庫設計 (Database Schema)

資料庫託管於 Supabase (PostgreSQL)。

### 2.1 `trip_config` (旅程設定)
單行記錄 (`singleton`)，存儲整趟旅程的全域設定。

| Column | Type | Description |
| :--- | :--- | :--- |
| `id` | `bigint` | PK |
| `companions` | `jsonb` | 旅伴陣列，例：`["Alice", "Bob", "Charlie"]` |
| `flight_info` | `jsonb` | 航班資訊物件。包含 `flights` (陣列), `startDate`, `endDate`。 |
| `hotel_info` | `jsonb` | 住宿資訊。包含 `name`, `address` (英文), `addressLocal` (當地語言), `phone`, `notes`。 |

### 2.2 `itineraries` (行程表)
存儲每日的具體活動。

| Column | Type | Description |
| :--- | :--- | :--- |
| `id` | `bigint` | PK |
| `date` | `date` | 活動日期，用於分組顯示。 |
| `start_time` | `time` | 24小時制開始時間 (`HH:mm`)。 |
| `location` | `text` | 地點名稱 (如 "成田機場")。 |
| `category` | `text` | 類別枚舉：`transport`, `activity`, `food`, `stay`。 |
| `notes` | `text` | 詳細備註、Google Maps 連結或其他資訊。 |

### 2.3 `expenses` (共用錢包)
**[12/09 更新]** 支援多幣別與拆帳細節。

| Column | Type | Description |
| :--- | :--- | :--- |
| `id` | `bigint` | PK |
| `created_at` | `timestamp` | 建立時間，用於排序。 |
| `item_name` | `text` | 消費項目名稱 (例："晚餐", "計程車")。 |
| `amount` | `numeric` | 此筆消費的總金額。 |
| `currency` | `text` | **[NEW]** 幣別代碼 (TWD, JPY, KRW, USD, etc.)。 |
| `payer` | `text` | 付款人 (必須是 `trip_config.companions` 之一)。 |
| `split_details` | `jsonb` | 分帳細節。格式：`{ "Alice": 333, "Bob": 333 }` (該人應付金額)。 |

> **開發環境 RLS 說明**：目前開發階段已透過 SQL Script 開放 `anon` 角色對上述表格的 CRUD 權限，以便在未登入狀態下測試。

---

## 3. 功能模組與實作細節 (Implementation Details)

### 3.1 資訊頁 (Info Page)
*   **功能**：管理航班、住宿與旅伴。
*   **特色**：
    *   **Conditional Rendering**：電話與備註欄位若為空，在 View Mode 自動隱藏。
    *   **Connecting Flights**：支援多段航班輸入。
    *   **Edit Mode**：點擊右上角編輯按鈕進入修改模式，使用 `updateMutation` 同步至 Supabase。

### 3.2 行程頁 (Itinerary Page)
*   **功能**：時間軸式的行程檢視。
*   **特色**：
    *   **Timeline UI**：左側顯示時間，右側顯示卡片。
    *   **Map Integration (Roadmap)**：
        *   目前邏輯：解析 `notes` 中的 Google Maps URL。
        *   提取規則：從 URL 中提取 `@lat,lng` 座標與 `z` (zoom level)。
        *   預設 Zoom：若無指定，預設為 `10`。
    *   **Direct Seeding**：包含一個隱藏或開發用的 Seeding 機制，可快速填入測試資料。

### 3.3 記帳頁 (Expenses Page)
*   **功能**：多人分帳與匯率換算。
*   **[12/09 重構] 新架構**：
    1.  **Always-Visible Converter (Header)**：
        *   常駐於頂部的匯率換算器。
        *   介面簡化：移除 Input Spin Buttons，優化 TWD 顯示空間。
        *   邏輯：前端 State 即時計算 `Amount * Rate`。
    2.  **Multi-Currency Dashboard**：
        *   **Total Spent**：依幣別分開加總顯示 (例：`$5000 TWD + ¥20000 JPY`)。
        *   **Net Balances**：分幣別計算欠款。
            *   邏輯：`Balance = (我支付的) - (我應付的)`。
            *   正值 = 別人欠我 (綠色)；負值 = 我欠公款 (粉色)。
    3.  **Add Expense Modal**：
        *   **Currency Selector**：新增幣別下拉選單。
        *   **Split Logic**：預設為「均分」，勾選參與者後自動計算每人應付金額 (`Amount / N`) 並存入 `split_details`。
        *   **UI Optimizations**：
            *   FAB (Floating Action Button) 位於右下角。
            *   Modal 底部按鈕避開 iOS Safe Area，並增加 Padding 防止遮擋。

---

## 4. UI/UX 設計規範 (Design System)

### 4.1 色彩系統 (Macaron Palette)
自定義 Tailwind 顏色，營造柔和、旅遊休閒感：
*   `bg-macaron-blue` / `text-macaron-blue` (天空藍)
*   `bg-macaron-pink` / `text-macaron-pink` (粉嫩紅)
*   `bg-macaron-yellow` / `text-macaron-yellow` (檸檬黃)
*   `bg-macaron-green` (草地綠)

### 4.2 互動元件
*   **Buttons**：圓角較大 `rounded-2xl`，點擊時有 `active:scale-95` 的微縮放回饋。
*   **Inputs**：移除標準瀏覽器的 Spin Buttons (`appearance: none`)，提供更乾淨的數值輸入體驗。
*   **Modals**：由底部滑出的 Bottom Sheet 風格，在手機上操作更直觀。

---

## 5. 未來開發路線圖 (Roadmap)

以下功能為下一階段開發重點：

1.  **Google Map 深度整合 (Google Map Integration)**
    *   目標：在行程卡片中直接嵌入互動地圖，而非僅顯示連結。
    *   技術：使用 Google Maps JavaScript API 或 Embed API。
    *   功能：根據 `location` 或 `notes` 中的座標顯示 Pin 點。

2.  **使用者登入 (User Authentication)**
    *   目標：從「單機版/開發版」轉向「多人協作版」。
    *   **實作細節 (Implementation)**：
        *   **Provider**：Google Login (via Supabase Auth).
        *   **Flow**：未登入者重定向至 `/login` 頁面。
        *   **Context**：建立 `AuthContext` 封裝 `user` 與 `session` 物件。
    *   資料：將所有資料表 (`trip_config`, `expenses`...) 增加 `user_id` 或 `trip_id` FK，並啟用嚴格的 RLS Policy。

3.  **公告欄 (Announcements)**
    *   目標：置頂重要訊息 (如：集合時間、注意事項)。
    *   位置：首頁 (Info) 或行程頁 (Itinerary) 頂部。

4.  **多行程規劃 (Multi-Trip Planning) - Hub & Spoke 架構**
    *   目標：允許使用者建立並切換多個不同的旅程。
    *   **架構異動 (New Architecture)**：
        *   **Database**：新增 `trips` 表 (Master Table)，包含 `id`, `name`, `dates`, `cover_photo`。
        *   **Routing**：
            *   `/` (Hub)：行程列表 (Trip List)，作為 App 入口。
            *   `/trips/:tripId/` (Spoke)：單一行程的 Root，例如 `/trips/123/expenses`。
        *   **Navigation**：進入行程後，所有的 Bottom Bar 操作僅限於該行程 ID。左上角提供 `< Back` 按鈕返回 Hub。

5.  **Markdown 輸出 (Export)**
    *   目標：將行程表與記帳明細匯出為 Markdown 純文字檔，方便分享或存入 Notion/Obsidian。

6.  **旅程共享 (Trip Sharing) - 邀請連結方案**
    *   **策略**：採用 **Plan A (Invitation Links)** 以降低加入門檻。
    *   **流程**：
        1.  Owner 分享連結 (如 `app/join/:inviteCode`)。
        2.  受邀者點擊連結 -> 登入 (Google Auth) -> 系統將 `auth.uid()` 寫入 `trip_members` 表。
        3.  受邀者自動獲得 Editor 權限 (可協作但不可刪除行程)。
    *   **資料庫變更**：
        *   新增 `trip_members` 關聯表 (`trip_id`, `user_id`, `role`)。
        *   更新 RLS Policy：允許 `trip_members` 中的成員讀寫對應行程。